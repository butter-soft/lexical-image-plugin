{"version":3,"file":"index.js","names":["INSERT_IMAGE_COMMAND: LexicalCommand<InsertImagePayload>","SWITCH_IMAGES_COMMAND: LexicalCommand<SwitchImageData[]>","RIGHT_CLICK_IMAGE_COMMAND: LexicalCommand<MouseEvent>","value: number","min: number","max: number","editor: LexicalEditor","direction: number","userSelectRef: RefObject<UserSelect>","imageRef: RefObject<HTMLElement | null>","controlWrapperRef: RefObject<HTMLDivElement | null>","positioningRef: RefObject<Positioning>","maxWidth?: number","event: PointerEvent","diff","width","onResizeEnd: (\n      width: \"inherit\" | number,\n      height: \"inherit\" | number,\n    ) => void","params: PointerDownHandlerParams","event: React.PointerEvent<HTMLDivElement>","params: Omit<PointerDownHandlerParams, \"direction\">","handlePointerDown","node: LexicalNode | null | undefined","src: string","src: string","width: \"inherit\" | number","height: \"inherit\" | number","maxWidth: number","isSVGImage: boolean","isFocused: boolean","dimensions?: {\n    width: number;\n    height: number;\n  }","width","height","event: KeyboardEvent","payload: MouseEvent","event: MouseEvent","nextWidth: \"inherit\" | number","nextHeight: \"inherit\" | number","domNode: Node","src: string","alt: string","maxWidth: number","key?: NodeKey","width?: \"inherit\" | number","height?: \"inherit\" | number","node: ImageNode","node: Node","serializedNode: SerializedImageNode","width: \"inherit\" | number","height: \"inherit\" | number","config: EditorConfig","newSrc: string"],"sources":["../src/commands.ts","../src/components/resizer/constants.ts","../src/utils.ts","../src/components/resizer/handler.ts","../src/components/resizer/index.tsx","../src/helper.ts","../src/components/container/constants.ts","../src/components/container/broken.tsx","../src/components/container/hooks.ts","../src/components/container/lazy.tsx","../src/components/container/index.tsx","../src/node.tsx","../src/plugin.ts"],"sourcesContent":["import type { InsertImagePayload, SwitchImageData } from \"@/types\";\nimport type { LexicalCommand } from \"lexical\";\nimport { createCommand } from \"lexical\";\n\nconst INSERT_IMAGE_COMMAND: LexicalCommand<InsertImagePayload> = createCommand(\n  \"INSERT_IMAGE_COMMAND\",\n);\n\nconst SWITCH_IMAGES_COMMAND: LexicalCommand<SwitchImageData[]> = createCommand(\n  \"SWITCH_IMAGES_COMMAND\",\n);\n\nconst RIGHT_CLICK_IMAGE_COMMAND: LexicalCommand<MouseEvent> = createCommand(\n  \"RIGHT_CLICK_IMAGE_COMMAND\",\n);\n\nexport {\n  INSERT_IMAGE_COMMAND,\n  RIGHT_CLICK_IMAGE_COMMAND,\n  SWITCH_IMAGES_COMMAND,\n};\n","export const Direction = {\n  east: 1 << 0,\n  north: 1 << 3,\n  south: 1 << 1,\n  west: 1 << 2,\n};\n","import { CAN_USE_DOM } from \"@lexical/utils\";\n\nconst getDOMSelection = (targetWindow: Window | null): Selection | null =>\n  CAN_USE_DOM ? (targetWindow || globalThis.window).getSelection() : null;\n\nconst clamp = (value: number, min: number, max: number) =>\n  Math.min(Math.max(value, min), max);\n\nexport { clamp, getDOMSelection };\n","import { clamp } from \"@/utils\";\nimport { calculateZoomLevel } from \"@lexical/utils\";\nimport type { LexicalEditor } from \"lexical\";\nimport type { RefObject } from \"react\";\nimport { Direction } from \"./constants\";\nimport type { Positioning, UserSelect } from \"./types\";\n\nconst setStartCursor = (\n  editor: LexicalEditor,\n  direction: number,\n  userSelectRef: RefObject<UserSelect>,\n) => {\n  const editorRootElement = editor.getRootElement();\n\n  const ew = direction === Direction.east || direction === Direction.west;\n  const ns = direction === Direction.north || direction === Direction.south;\n  const nwse =\n    (direction & Direction.north && direction & Direction.west) ||\n    (direction & Direction.south && direction & Direction.east);\n\n  const cursorDir = ew ? \"ew\" : ns ? \"ns\" : nwse ? \"nwse\" : \"nesw\";\n\n  if (editorRootElement !== null) {\n    editorRootElement.style.setProperty(\n      \"cursor\",\n      `${cursorDir}-resize`,\n      \"important\",\n    );\n  }\n  if (document.body !== null) {\n    document.body.style.setProperty(\n      \"cursor\",\n      `${cursorDir}-resize`,\n      \"important\",\n    );\n    userSelectRef.current.value = document.body.style.getPropertyValue(\n      \"-webkit-user-select\",\n    );\n    userSelectRef.current.priority = document.body.style.getPropertyPriority(\n      \"-webkit-user-select\",\n    );\n    document.body.style.setProperty(\"-webkit-user-select\", `none`, \"important\");\n  }\n};\n\nconst setEndCursor = (\n  editor: LexicalEditor,\n  userSelectRef: RefObject<UserSelect>,\n) => {\n  const editorRootElement = editor.getRootElement();\n\n  if (editorRootElement !== null) {\n    editorRootElement.style.setProperty(\"cursor\", \"text\");\n  }\n  if (document.body !== null) {\n    document.body.style.setProperty(\"cursor\", \"default\");\n    document.body.style.setProperty(\n      \"-webkit-user-select\",\n      userSelectRef.current.value,\n      userSelectRef.current.priority,\n    );\n  }\n};\n\nconst handlePointerMove =\n  (\n    editor: LexicalEditor,\n    imageRef: RefObject<HTMLElement | null>,\n    controlWrapperRef: RefObject<HTMLDivElement | null>,\n    positioningRef: RefObject<Positioning>,\n    maxWidth?: number,\n  ) =>\n  (event: PointerEvent) => {\n    const editorRootElement = editor.getRootElement();\n\n    // Find max width, accounting for editor padding.\n    const maxWidthContainer = maxWidth\n      ? maxWidth\n      : editorRootElement !== null\n        ? editorRootElement.getBoundingClientRect().width - 20\n        : 100;\n    const maxHeightContainer =\n      editorRootElement !== null\n        ? editorRootElement.getBoundingClientRect().height - 20\n        : 100;\n\n    const minWidth = 100;\n    const minHeight = 100;\n\n    const image = imageRef.current;\n    const positioning = positioningRef.current;\n    const controlWrapper = controlWrapperRef.current;\n\n    const isHorizontal =\n      positioning.direction & (Direction.east | Direction.west);\n    const isVertical =\n      positioning.direction & (Direction.south | Direction.north);\n\n    if (image !== null && controlWrapper !== null && positioning.isResizing) {\n      const zoom = calculateZoomLevel(image);\n\n      // Corner cursor\n      if (isHorizontal && isVertical) {\n        let diff = Math.floor(positioning.startX - event.clientX / zoom);\n        diff = positioning.direction & Direction.east ? -diff : diff;\n\n        const width = clamp(\n          positioning.startWidth + diff,\n          minWidth,\n          maxWidthContainer,\n        );\n\n        const height = width / positioning.ratio;\n        image.style.width = `${width}px`;\n        image.style.height = `${height}px`;\n        positioning.currentWidth = width;\n        positioning.currentHeight = height;\n        controlWrapper.style.width = `${width}px`;\n        controlWrapper.style.height = `${height}px`;\n\n        return;\n      }\n\n      if (isVertical) {\n        let diff = Math.floor(positioning.startY - event.clientY / zoom);\n        diff = positioning.direction & Direction.south ? -diff : diff;\n\n        const height = clamp(\n          positioning.startHeight + diff,\n          minHeight,\n          maxHeightContainer,\n        );\n\n        image.style.height = `${height}px`;\n        positioning.currentHeight = height;\n        controlWrapper.style.height = `${height}px`;\n\n        return;\n      }\n\n      let diff = Math.floor(positioning.startX - event.clientX / zoom);\n      diff = positioning.direction & Direction.east ? -diff : diff;\n\n      const width = clamp(\n        positioning.startWidth + diff,\n        minWidth,\n        maxWidthContainer,\n      );\n\n      image.style.width = `${width}px`;\n      positioning.currentWidth = width;\n      controlWrapper.style.width = `${width}px`;\n    }\n  };\n\nconst handlePointerUp =\n  (\n    editor: LexicalEditor,\n    imageRef: RefObject<HTMLElement | null>,\n    controlWrapperRef: RefObject<HTMLDivElement | null>,\n    positioningRef: RefObject<Positioning>,\n    userSelectRef: RefObject<UserSelect>,\n    onResizeEnd: (\n      width: \"inherit\" | number,\n      height: \"inherit\" | number,\n    ) => void,\n    maxWidth?: number,\n  ) =>\n  () => {\n    const image = imageRef.current;\n    const positioning = positioningRef.current;\n    const controlWrapper = controlWrapperRef.current;\n    if (image !== null && controlWrapper !== null && positioning.isResizing) {\n      const width = positioning.currentWidth;\n      const height = positioning.currentHeight;\n      positioning.startWidth = 0;\n      positioning.startHeight = 0;\n      positioning.ratio = 0;\n      positioning.startX = 0;\n      positioning.startY = 0;\n      positioning.currentWidth = 0;\n      positioning.currentHeight = 0;\n      positioning.isResizing = false;\n\n      controlWrapper.classList.remove(\"image-control-wrapper--resizing\");\n\n      setEndCursor(editor, userSelectRef);\n      onResizeEnd(width, height);\n\n      document.removeEventListener(\n        \"pointermove\",\n        handlePointerMove(\n          editor,\n          imageRef,\n          controlWrapperRef,\n          positioningRef,\n          maxWidth,\n        ),\n      );\n      document.removeEventListener(\n        \"pointerup\",\n        handlePointerUp(\n          editor,\n          imageRef,\n          controlWrapperRef,\n          positioningRef,\n          userSelectRef,\n          onResizeEnd,\n          maxWidth,\n        ),\n      );\n    }\n  };\n\ntype PointerDownHandlerParams = {\n  editor: LexicalEditor;\n  direction: number;\n  imageRef: RefObject<HTMLElement | null>;\n  controlWrapperRef: RefObject<HTMLDivElement | null>;\n  positioningRef: RefObject<Positioning>;\n  userSelectRef: RefObject<UserSelect>;\n  onResizeStart: () => void;\n  onResizeEnd: (width: \"inherit\" | number, height: \"inherit\" | number) => void;\n  maxWidth?: number;\n};\n\nconst handlePointerDown =\n  (params: PointerDownHandlerParams) =>\n  (event: React.PointerEvent<HTMLDivElement>) => {\n    const {\n      editor,\n      imageRef,\n      controlWrapperRef,\n      positioningRef,\n      direction,\n      userSelectRef,\n      onResizeStart,\n      onResizeEnd,\n      maxWidth,\n    } = params;\n\n    if (!editor.isEditable()) {\n      return;\n    }\n\n    const image = imageRef.current;\n    const controlWrapper = controlWrapperRef.current;\n\n    if (image !== null && controlWrapper !== null) {\n      event.preventDefault();\n      const { width, height } = image.getBoundingClientRect();\n      const zoom = calculateZoomLevel(image);\n      const positioning = positioningRef.current;\n      positioning.startWidth = width;\n      positioning.startHeight = height;\n      positioning.ratio = width / height;\n      positioning.currentWidth = width;\n      positioning.currentHeight = height;\n      positioning.startX = event.clientX / zoom;\n      positioning.startY = event.clientY / zoom;\n      positioning.isResizing = true;\n      positioning.direction = direction;\n\n      setStartCursor(editor, direction, userSelectRef);\n      onResizeStart();\n\n      controlWrapper.classList.add(\"image-control-wrapper--resizing\");\n      image.style.height = `${height}px`;\n      image.style.width = `${width}px`;\n\n      document.addEventListener(\n        \"pointermove\",\n        handlePointerMove(\n          editor,\n          imageRef,\n          controlWrapperRef,\n          positioningRef,\n          maxWidth,\n        ),\n      );\n      document.addEventListener(\n        \"pointerup\",\n        handlePointerUp(\n          editor,\n          imageRef,\n          controlWrapperRef,\n          positioningRef,\n          userSelectRef,\n          onResizeEnd,\n          maxWidth,\n        ),\n      );\n    }\n  };\n\nexport const onPointerDown =\n  (params: Omit<PointerDownHandlerParams, \"direction\">) =>\n  (direction: number) =>\n    handlePointerDown({ ...params, direction });\n","import type { LexicalEditor } from \"lexical\";\nimport { useRef, type RefObject } from \"react\";\n\nimport { Direction } from \"./constants\";\nimport { onPointerDown } from \"./handler\";\nimport type { Positioning } from \"./types\";\n\nconst ImageResizer = ({\n  onResizeStart,\n  onResizeEnd,\n  imageRef,\n  maxWidth,\n  editor,\n}: {\n  editor: LexicalEditor;\n  imageRef: RefObject<HTMLElement | null>;\n  maxWidth?: number;\n  onResizeEnd: (width: \"inherit\" | number, height: \"inherit\" | number) => void;\n  onResizeStart: () => void;\n}) => {\n  const controlWrapperRef = useRef<HTMLDivElement>(null);\n  const userSelect = useRef({\n    priority: \"\",\n    value: \"default\",\n  });\n  const positioningRef = useRef<Positioning>({\n    currentHeight: 0,\n    currentWidth: 0,\n    direction: 0,\n    isResizing: false,\n    ratio: 0,\n    startHeight: 0,\n    startWidth: 0,\n    startX: 0,\n    startY: 0,\n  });\n\n  const handlePointerDown = onPointerDown({\n    editor,\n    imageRef,\n    controlWrapperRef,\n    positioningRef,\n    userSelectRef: userSelect,\n    onResizeStart,\n    onResizeEnd,\n    maxWidth,\n  });\n\n  return (\n    <div\n      style={{\n        position: \"absolute\",\n        top: 0,\n        left: 0,\n        width: imageRef.current?.clientWidth,\n        height: imageRef.current?.clientHeight,\n      }}\n      ref={controlWrapperRef}\n    >\n      <div\n        style={{\n          position: \"absolute\",\n          width: \"0.5rem\",\n          height: \"0.5rem\",\n          backgroundColor: \"black\",\n          top: \"-0.25rem\",\n          left: \"50%\",\n          transform: \"translateX(-50%)\",\n          cursor: \"ns-resize\",\n        }}\n        onPointerDown={handlePointerDown(Direction.north)}\n      />\n      <div\n        style={{\n          position: \"absolute\",\n          width: \"0.5rem\",\n          height: \"0.5rem\",\n          backgroundColor: \"black\",\n          right: \"-0.25rem\",\n          top: \"-0.25rem\",\n          cursor: \"nesw-resize\",\n        }}\n        onPointerDown={handlePointerDown(Direction.north | Direction.east)}\n      />\n      <div\n        style={{\n          position: \"absolute\",\n          width: \"0.5rem\",\n          height: \"0.5rem\",\n          backgroundColor: \"black\",\n          top: \"50%\",\n          right: \"-0.25rem\",\n          transform: \"translateY(-50%)\",\n          cursor: \"ew-resize\",\n        }}\n        onPointerDown={handlePointerDown(Direction.east)}\n      />\n      <div\n        style={{\n          position: \"absolute\",\n          width: \"0.5rem\",\n          height: \"0.5rem\",\n          backgroundColor: \"black\",\n          bottom: \"-0.25rem\",\n          right: \"-0.25rem\",\n          cursor: \"nwse-resize\",\n        }}\n        onPointerDown={handlePointerDown(Direction.south | Direction.east)}\n      />\n      <div\n        style={{\n          position: \"absolute\",\n          width: \"0.5rem\",\n          height: \"0.5rem\",\n          backgroundColor: \"black\",\n          bottom: \"-0.25rem\",\n          left: \"50%\",\n          transform: \"translateX(-50%)\",\n          cursor: \"ns-resize\",\n        }}\n        onPointerDown={handlePointerDown(Direction.south)}\n      />\n      <div\n        style={{\n          position: \"absolute\",\n          width: \"0.5rem\",\n          height: \"0.5rem\",\n          backgroundColor: \"black\",\n          bottom: \"-0.25rem\",\n          left: \"-0.25rem\",\n          cursor: \"nesw-resize\",\n        }}\n        onPointerDown={handlePointerDown(Direction.south | Direction.west)}\n      />\n      <div\n        style={{\n          position: \"absolute\",\n          width: \"0.5rem\",\n          height: \"0.5rem\",\n          backgroundColor: \"black\",\n          left: \"-0.25rem\",\n          top: \"50%\",\n          transform: \"translateY(-50%)\",\n          cursor: \"ew-resize\",\n        }}\n        onPointerDown={handlePointerDown(Direction.west)}\n      />\n      <div\n        style={{\n          position: \"absolute\",\n          width: \"0.5rem\",\n          height: \"0.5rem\",\n          backgroundColor: \"black\",\n          left: \"-0.25rem\",\n          top: \"-0.25rem\",\n          cursor: \"nwse-resize\",\n        }}\n        onPointerDown={handlePointerDown(Direction.north | Direction.west)}\n      />\n    </div>\n  );\n};\n\nexport { ImageResizer };\n","import type { ImageNode } from \"@/node\";\nimport type { LexicalNode } from \"lexical\";\nimport { $getSelection, $isNodeSelection } from \"lexical\";\n\nexport const $isImageNode = (\n  node: LexicalNode | null | undefined,\n): node is ImageNode => node?.getType() === \"image\";\n\nexport const $getImageNodeInSelection = (): ImageNode | null => {\n  const selection = $getSelection();\n  if (!$isNodeSelection(selection)) {\n    return null;\n  }\n  const nodes = selection.getNodes();\n  const node = nodes[0];\n  return $isImageNode(node) ? node : null;\n};\n","export const BROKEN_IMAGE =\n  \"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWltYWdlLW9mZiI+PGxpbmUgeDE9IjIiIHgyPSIyMiIgeTE9IjIiIHkyPSIyMiIvPjxwYXRoIGQ9Ik0xMC40MSAxMC40MWEyIDIgMCAxIDEtMi44My0yLjgzIi8+PGxpbmUgeDE9IjEzLjUiIHgyPSI2IiB5MT0iMTMuNSIgeTI9IjIxIi8+PGxpbmUgeDE9IjE4IiB4Mj0iMjEiIHkxPSIxMiIgeTI9IjE1Ii8+PHBhdGggZD0iTTMuNTkgMy41OUExLjk5IDEuOTkgMCAwIDAgMyA1djE0YTIgMiAwIDAgMCAyIDJoMTRjLjU1IDAgMS4wNTItLjIyIDEuNDEtLjU5Ii8+PHBhdGggZD0iTTIxIDE1VjVhMiAyIDAgMCAwLTItMkg5Ii8+PC9zdmc+\";\n","import { BROKEN_IMAGE } from \"./constants\";\n\nexport const BrokenImage = () => {\n  return (\n    <img\n      src={BROKEN_IMAGE}\n      style={{\n        height: 200,\n        opacity: 0.2,\n        width: 200,\n      }}\n      draggable=\"false\"\n    />\n  );\n};\n","const imageCache = new Map<string, Promise<boolean> | boolean>();\n\nexport const useSuspenseImage = (src: string) => {\n  let cached = imageCache.get(src);\n\n  if (typeof cached === \"boolean\") {\n    return cached;\n  }\n\n  if (!cached) {\n    cached = new Promise<boolean>((resolve) => {\n      const img = new Image();\n      img.src = src;\n      img.onload = () => resolve(false);\n      img.onerror = () => resolve(true);\n    }).then((hasError) => {\n      imageCache.set(src, hasError);\n      return hasError;\n    });\n\n    imageCache.set(src, cached);\n    throw cached;\n  }\n\n  throw cached;\n};\n","import type { ImageProps } from \"@/types\";\nimport { useEffect, useState, type CSSProperties, type RefObject } from \"react\";\nimport { BrokenImage } from \"./broken\";\nimport { useSuspenseImage } from \"./hooks\";\n\nconst isSVG = (src: string) => src.toLowerCase().endsWith(\".svg\");\n\nconst calculateStyles = (\n  width: \"inherit\" | number,\n  height: \"inherit\" | number,\n  maxWidth: number,\n  isSVGImage: boolean,\n  isFocused: boolean,\n  dimensions?: {\n    width: number;\n    height: number;\n  },\n): CSSProperties => {\n  if (!isSVGImage) {\n    return {\n      height,\n      maxWidth,\n      width,\n      boxShadow: isFocused ? \"0 0 0 1px black\" : undefined,\n    };\n  }\n\n  const naturalWidth = dimensions?.width || 200;\n  const naturalHeight = dimensions?.height || 200;\n\n  let finalWidth = naturalWidth;\n  let finalHeight = naturalHeight;\n\n  if (finalWidth > maxWidth) {\n    const scale = maxWidth / finalWidth;\n    finalWidth = maxWidth;\n    finalHeight = Math.round(finalHeight * scale);\n  }\n\n  const maxHeight = 500;\n  if (finalHeight > maxHeight) {\n    const scale = maxHeight / finalHeight;\n    finalHeight = maxHeight;\n    finalWidth = Math.round(finalWidth * scale);\n  }\n\n  return {\n    height: finalHeight,\n    maxWidth,\n    width: finalWidth,\n    boxShadow: isFocused ? \"0 0 0 1px black\" : undefined,\n  };\n};\n\nexport const LazyImage = ({\n  src,\n  alt,\n  imageRef,\n  onError,\n  width,\n  height,\n  maxWidth,\n  isFocused,\n  className,\n}: Omit<ImageProps, \"key\" | \"resizable\"> & {\n  imageRef: RefObject<HTMLImageElement | null>;\n  onError: () => void;\n  isFocused: boolean;\n  className?: undefined;\n}) => {\n  const [dimensions, setDimensions] = useState<{\n    width: number;\n    height: number;\n  }>();\n  const isSVGImage = isSVG(src);\n\n  useEffect(() => {\n    if (imageRef.current && isSVGImage) {\n      const { naturalWidth, naturalHeight } = imageRef.current;\n      setDimensions({\n        height: naturalHeight,\n        width: naturalWidth,\n      });\n    }\n  }, [imageRef, isSVGImage]);\n\n  const hasError = useSuspenseImage(src);\n\n  useEffect(() => {\n    if (hasError) {\n      onError();\n    }\n  }, [hasError, onError]);\n\n  if (hasError) {\n    return <BrokenImage />;\n  }\n\n  const style = calculateStyles(\n    width,\n    height,\n    maxWidth,\n    isSVGImage,\n    isFocused,\n    dimensions,\n  );\n\n  return (\n    <img\n      className={className}\n      src={src}\n      alt={alt}\n      ref={imageRef}\n      onError={onError}\n      style={style}\n      draggable=\"false\"\n      onLoad={(e) => {\n        if (isSVGImage) {\n          const { naturalWidth: width, naturalHeight: height } =\n            e.currentTarget;\n          setDimensions({ width, height });\n        }\n      }}\n    />\n  );\n};\n","import { RIGHT_CLICK_IMAGE_COMMAND } from \"@/commands\";\nimport { ImageResizer } from \"@/components/resizer\";\nimport { $isImageNode } from \"@/helper\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport { useLexicalEditable } from \"@lexical/react/useLexicalEditable\";\nimport { useLexicalNodeSelection } from \"@lexical/react/useLexicalNodeSelection\";\nimport { mergeRegister } from \"@lexical/utils\";\nimport {\n  $getNodeByKey,\n  $getSelection,\n  $isNodeSelection,\n  $isRangeSelection,\n  $setSelection,\n  CLICK_COMMAND,\n  COMMAND_PRIORITY_LOW,\n  DRAGSTART_COMMAND,\n  KEY_ENTER_COMMAND,\n  KEY_ESCAPE_COMMAND,\n  SELECTION_CHANGE_COMMAND,\n  type BaseSelection,\n  type LexicalEditor,\n  type NodeKey,\n} from \"lexical\";\nimport { Suspense, useCallback, useEffect, useRef, useState } from \"react\";\nimport { BrokenImage } from \"./broken\";\nimport { LazyImage } from \"./lazy\";\n\nconst ImageContainer = ({\n  src,\n  alt,\n  nodeKey,\n  width,\n  height,\n  maxWidth,\n  resizable,\n}: {\n  src: string;\n  alt: string;\n  nodeKey: NodeKey;\n  width: \"inherit\" | number;\n  height: \"inherit\" | number;\n  maxWidth: number;\n  resizable: boolean;\n}) => {\n  const [editor] = useLexicalComposerContext();\n  const [isSelected, setSelected, clearSelection] =\n    useLexicalNodeSelection(nodeKey);\n  const isEditable = useLexicalEditable();\n\n  const imageRef = useRef<null | HTMLImageElement>(null);\n  const activeEditorRef = useRef<LexicalEditor | null>(null);\n\n  const [isLoadError, setIsLoadError] = useState<boolean>(false);\n  const [isResizing, setIsResizing] = useState<boolean>(false);\n\n  const [selection, setSelection] = useState<BaseSelection | null>(null);\n\n  const $onEnter = useCallback(\n    (event: KeyboardEvent) => {\n      console.log(\"$onEnter\");\n\n      const latestSelection = $getSelection();\n\n      if (\n        isSelected &&\n        $isNodeSelection(latestSelection) &&\n        latestSelection.getNodes().length === 1\n      ) {\n        return true;\n      }\n\n      return false;\n    },\n    [isSelected],\n  );\n\n  const $onEscape = useCallback(\n    (event: KeyboardEvent) => {\n      console.log(\"$onEscape\");\n      if (isSelected) {\n        $setSelection(null);\n        editor.update(() => {\n          setSelected(true);\n          const parentRootElement = editor.getRootElement();\n          if (parentRootElement !== null) {\n            parentRootElement.focus();\n          }\n        });\n        return true;\n      }\n      return false;\n    },\n    [editor, setSelected],\n  );\n\n  const onClick = useCallback(\n    (payload: MouseEvent) => {\n      const event = payload;\n\n      if (isResizing) {\n        return true;\n      }\n      if (event.target === imageRef.current) {\n        if (event.shiftKey) {\n          setSelected(!isSelected);\n        } else {\n          clearSelection();\n          setSelected(true);\n        }\n        return true;\n      }\n\n      return false;\n    },\n    [isResizing, isSelected, setSelected, clearSelection],\n  );\n\n  const onRightClick = useCallback(\n    (event: MouseEvent): void => {\n      editor.getEditorState().read(() => {\n        const latestSelection = $getSelection();\n        const domElement = event.target as HTMLElement;\n        if (\n          domElement.tagName === \"IMG\" &&\n          $isRangeSelection(latestSelection) &&\n          latestSelection.getNodes().length === 1\n        ) {\n          editor.dispatchCommand(\n            RIGHT_CLICK_IMAGE_COMMAND,\n            event as MouseEvent,\n          );\n        }\n      });\n    },\n    [editor],\n  );\n\n  useEffect(() => {\n    const rootElement = editor.getRootElement();\n    const unregister = mergeRegister(\n      editor.registerUpdateListener(({ editorState }) => {\n        const updatedSelection = editorState.read(() => $getSelection());\n        if ($isNodeSelection(updatedSelection)) {\n          setSelection(updatedSelection);\n        } else {\n          setSelection(null);\n        }\n      }),\n      editor.registerCommand(\n        SELECTION_CHANGE_COMMAND,\n        (_, activeEditor) => {\n          activeEditorRef.current = activeEditor;\n          return false;\n        },\n        COMMAND_PRIORITY_LOW,\n      ),\n      editor.registerCommand<MouseEvent>(\n        CLICK_COMMAND,\n        onClick,\n        COMMAND_PRIORITY_LOW,\n      ),\n      editor.registerCommand<MouseEvent>(\n        RIGHT_CLICK_IMAGE_COMMAND,\n        onClick,\n        COMMAND_PRIORITY_LOW,\n      ),\n      editor.registerCommand(\n        DRAGSTART_COMMAND,\n        (event) => {\n          if (event.target === imageRef.current) {\n            // TODO This is just a temporary workaround for FF to behave like other browsers.\n            // Ideally, this handles drag & drop too (and all browsers).\n            event.preventDefault();\n            return true;\n          }\n          return false;\n        },\n        COMMAND_PRIORITY_LOW,\n      ),\n      editor.registerCommand(KEY_ENTER_COMMAND, $onEnter, COMMAND_PRIORITY_LOW),\n      editor.registerCommand(\n        KEY_ESCAPE_COMMAND,\n        $onEscape,\n        COMMAND_PRIORITY_LOW,\n      ),\n    );\n\n    rootElement?.addEventListener(\"contextmenu\", onRightClick);\n\n    return () => {\n      unregister();\n      rootElement?.removeEventListener(\"contextmenu\", onRightClick);\n    };\n  }, [\n    clearSelection,\n    editor,\n    isResizing,\n    isSelected,\n    nodeKey,\n    $onEnter,\n    $onEscape,\n    onClick,\n    onRightClick,\n    setSelected,\n  ]);\n\n  const onResizeEnd = (\n    nextWidth: \"inherit\" | number,\n    nextHeight: \"inherit\" | number,\n  ) => {\n    // Delay hiding the resize bars for click case\n    setTimeout(() => {\n      setIsResizing(false);\n    }, 200);\n\n    editor.update(() => {\n      const node = $getNodeByKey(nodeKey);\n      if ($isImageNode(node)) {\n        node.setWidthAndHeight(nextWidth, nextHeight);\n      }\n    });\n  };\n\n  const onResizeStart = () => {\n    setIsResizing(true);\n  };\n\n  const draggable = isSelected && $isNodeSelection(selection) && !isResizing;\n  const isFocused = (isSelected || isResizing) && isEditable;\n\n  return (\n    <Suspense fallback={null}>\n      <div draggable={draggable}>\n        {isLoadError ? (\n          <BrokenImage />\n        ) : (\n          <LazyImage\n            src={src}\n            alt={alt}\n            imageRef={imageRef}\n            width={width}\n            height={height}\n            maxWidth={maxWidth}\n            onError={() => setIsLoadError(true)}\n            isFocused={isFocused}\n          />\n        )}\n        {resizable && $isNodeSelection(selection) && isFocused && (\n          <ImageResizer\n            editor={editor}\n            imageRef={imageRef}\n            maxWidth={maxWidth}\n            onResizeStart={onResizeStart}\n            onResizeEnd={onResizeEnd}\n          />\n        )}\n      </div>\n    </Suspense>\n  );\n};\n\nexport { ImageContainer };\n","import * as React from \"react\";\n\nimport { $applyNodeReplacement, DecoratorNode } from \"lexical\";\n\nimport type { ImagePayload, SerializedImageNode } from \"@/types\";\nimport type {\n  DOMConversionMap,\n  DOMConversionOutput,\n  DOMExportOutput,\n  EditorConfig,\n  NodeKey,\n} from \"lexical\";\n\nimport { ImageContainer } from \"@/components/container\";\n\nconst $createImageNode = ({\n  src,\n  alt,\n  width,\n  height,\n  maxWidth = 640,\n  key,\n}: ImagePayload): ImageNode =>\n  $applyNodeReplacement(new ImageNode(src, alt, maxWidth, key, width, height));\n\nconst $convertImageElement = (domNode: Node): null | DOMConversionOutput => {\n  const img = domNode as HTMLImageElement;\n\n  if (img.src.startsWith(\"file:///\")) {\n    return null;\n  }\n  const { src, alt, width, height } = img;\n\n  return { node: $createImageNode({ src, alt, width, height }) };\n};\n\nclass ImageNode extends DecoratorNode<React.JSX.Element> {\n  __src: string;\n  __alt: string;\n  __width: \"inherit\" | number;\n  __height: \"inherit\" | number;\n  __maxWidth: number;\n\n  constructor(\n    src: string,\n    alt: string,\n    maxWidth: number,\n    key?: NodeKey,\n    width?: \"inherit\" | number,\n    height?: \"inherit\" | number,\n  ) {\n    super(key);\n    this.__src = src;\n    this.__alt = alt;\n    this.__maxWidth = maxWidth;\n    this.__width = width || \"inherit\";\n    this.__height = height || \"inherit\";\n  }\n\n  static override getType(): string {\n    return \"image\";\n  }\n\n  static override clone(node: ImageNode): ImageNode {\n    return new ImageNode(\n      node.__src,\n      node.__alt,\n      node.__maxWidth,\n      node.__key,\n      node.__width,\n      node.__height,\n    );\n  }\n\n  static override importDOM(): DOMConversionMap | null {\n    return {\n      img: (node: Node) => ({\n        conversion: () => $convertImageElement(node),\n        priority: 0,\n      }),\n    };\n  }\n\n  static override importJSON(serializedNode: SerializedImageNode) {\n    const { height, width, maxWidth, src, alt } = serializedNode;\n    const node = $createImageNode({\n      src,\n      alt,\n      width,\n      height,\n      maxWidth,\n    });\n\n    return node.updateFromJSON(serializedNode);\n  }\n\n  override exportDOM(): DOMExportOutput {\n    const element = document.createElement(\"img\");\n    element.setAttribute(\"src\", this.__src);\n    element.setAttribute(\"alt\", this.__alt);\n    element.setAttribute(\"width\", this.__width.toString());\n    element.setAttribute(\"height\", this.__height.toString());\n    return { element };\n  }\n\n  override exportJSON(): SerializedImageNode {\n    return {\n      src: this.getSrc(),\n      alt: this.getAlt(),\n      type: \"image\",\n      width: this.__width === \"inherit\" ? 0 : this.__width,\n      height: this.__height === \"inherit\" ? 0 : this.__height,\n      maxWidth: this.__maxWidth,\n      version: 1,\n    };\n  }\n\n  setWidthAndHeight(\n    width: \"inherit\" | number,\n    height: \"inherit\" | number,\n  ): void {\n    const writable = this.getWritable();\n    writable.__width = width;\n    writable.__height = height;\n  }\n\n  override createDOM(config: EditorConfig): HTMLElement {\n    const div = document.createElement(\"div\");\n\n    const theme = config.theme;\n    const className = theme.image;\n\n    if (className !== undefined) {\n      div.className = className;\n\n      return div;\n    }\n\n    // resizer boundary\n    div.style.position = \"relative\";\n\n    return div;\n  }\n\n  override updateDOM(): false {\n    return false;\n  }\n\n  getSrc(): string {\n    return this.__src;\n  }\n\n  setSrc(newSrc: string): void {\n    const writable = this.getWritable();\n    writable.__src = newSrc;\n  }\n\n  getAlt(): string {\n    return this.__alt;\n  }\n\n  override decorate(): React.JSX.Element {\n    return (\n      <React.Suspense fallback={null}>\n        <ImageContainer\n          src={this.__src}\n          alt={this.__alt}\n          width={this.__width}\n          height={this.__height}\n          maxWidth={this.__maxWidth}\n          nodeKey={this.getKey()}\n          resizable={true}\n        />\n      </React.Suspense>\n    );\n  }\n}\n\nexport { $createImageNode, ImageNode };\n","import { INSERT_IMAGE_COMMAND, SWITCH_IMAGES_COMMAND } from \"@/commands\";\nimport { $createImageNode, ImageNode } from \"@/node\";\nimport type { InsertImagePayload, SwitchImageData } from \"@/types\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport { $wrapNodeInElement, mergeRegister } from \"@lexical/utils\";\nimport {\n  $createParagraphNode,\n  $insertNodes,\n  $isRootOrShadowRoot,\n  COMMAND_PRIORITY_CRITICAL,\n  COMMAND_PRIORITY_EDITOR,\n} from \"lexical\";\nimport { useEffect } from \"react\";\n\nexport const ImagePlugin = () => {\n  const [editor] = useLexicalComposerContext();\n\n  useEffect(() => {\n    if (!editor.hasNodes([ImageNode])) {\n      throw new Error(\"ImagePlugin: ImageNode is not registered on editor\");\n    }\n\n    return mergeRegister(\n      editor.registerCommand<InsertImagePayload>(\n        INSERT_IMAGE_COMMAND,\n        (payload) => {\n          const imageNode = $createImageNode(payload);\n\n          $insertNodes([imageNode]);\n\n          if ($isRootOrShadowRoot(imageNode.getParentOrThrow())) {\n            $wrapNodeInElement(imageNode, $createParagraphNode).selectEnd();\n          }\n          return true;\n        },\n        COMMAND_PRIORITY_EDITOR,\n      ),\n      editor.registerCommand<SwitchImageData[]>(\n        SWITCH_IMAGES_COMMAND,\n        (payload) => {\n          payload.forEach(({ node, storageSrc }) => {\n            node.setSrc(storageSrc);\n          });\n\n          return true;\n        },\n        COMMAND_PRIORITY_CRITICAL,\n      ),\n      // TODO: DragEvent\n    );\n  }, [editor]);\n\n  return null;\n};\n"],"mappings":"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"}